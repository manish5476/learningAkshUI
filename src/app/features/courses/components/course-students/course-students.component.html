<div class="roster-container">
  <p-toast position="top-right"></p-toast>
  <p-confirmDialog styleClass="glass-dialog" [style]="{width: '450px'}"></p-confirmDialog>

  <div class="dashboard-header glass-panel mb-2xl">
    <div class="header-left">
      <button class="btn-icon btn-ghost" [routerLink]="['/instructor/courses', courseId()]">
        <i class="pi pi-arrow-left"></i>
      </button>
      <div>
        <h1 class="page-title gradient-text m-0">Student Roster</h1>
        <p class="course-title text-secondary mt-xs mb-0 font-mono">{{ courseTitle() }}</p>
      </div>
    </div>
    <div class="header-right">
      <div class="search-bar p-input-icon-left">
        <i class="pi pi-search text-tertiary"></i>
        <input type="text" pInputText [ngModel]="searchQuery()" (ngModelChange)="searchQuery.set($event)" placeholder="Search by name or email..." class="custom-input">
      </div>
      <button class="btn-glow outline ml-md">
        <i class="pi pi-download"></i> Export CSV
      </button>
    </div>
  </div>

  <div class="glass-panel table-container">
    <div class="table-header-row mb-lg">
      <h3 class="m-0 text-primary"><i class="pi pi-users"></i> Enrolled Students ({{ filteredStudents().length }})</h3>
    </div>

    @if (isLoading()) {
      <div class="loading-state">
        <i class="pi pi-spin pi-spinner text-primary" style="font-size: 2rem;"></i>
        <p class="text-secondary mt-md">Loading student data...</p>
      </div>
    } @else if (filteredStudents().length > 0) {
      <div class="custom-table-wrapper">
        <p-table [value]="filteredStudents()" [paginator]="true" [rows]="10" styleClass="p-datatable-glass">
          
          <ng-template pTemplate="header">
            <tr>
              <th>Student Profile</th>
              <th>Enrolled Date</th>
              <th>Payment Info</th>
              <th>Course Progress</th> 
              <th style="text-align: right">Actions</th>
            </tr>
          </ng-template>

          <ng-template pTemplate="body" let-enrollment>
            <tr>
              
              <td>
                <div class="student-cell">
                  @if (enrollment.student?.profilePicture) {
                    <img [src]="enrollment.student.profilePicture" class="s-avatar">
                  } @else {
                    <div class="s-avatar-fallback">
                      {{ getInitials(enrollment.student?.firstName, enrollment.student?.lastName) }}
                    </div>
                  }
                  <div class="s-info">
                    <span class="s-name font-medium">{{ enrollment.student?.firstName }} {{ enrollment.student?.lastName }}</span>
                    <span class="s-email text-xs text-tertiary">{{ enrollment.student?.email }}</span>
                  </div>
                </div>
              </td>

              <td class="font-mono text-sm text-secondary">
                {{ enrollment.enrolledAt | date:'mediumDate' }}
              </td>

              <td>
                @if (enrollment.payment) {
                  <p-tag [value]="'Paid'" severity="success" [rounded]="true"></p-tag>
                } @else {
                  <p-tag [value]="'Free / Manual'" severity="info" [rounded]="true"></p-tag>
                }
              </td>

              <td>
                <div class="progress-cell">
                  <p-progressBar [value]="enrollment.progress?.courseProgressPercentage || 0" [showValue]="false" styleClass="table-progress"></p-progressBar>
                  <span class="p-text text-xs font-bold" [ngClass]="(enrollment.progress?.courseProgressPercentage || 0) === 100 ? 'text-success' : 'text-info'">
                    {{ enrollment.progress?.courseProgressPercentage || 0 }}%
                  </span>
                </div>
              </td>

              <td style="text-align: right">
                <button class="btn-icon btn-danger" pTooltip="Revoke Access" tooltipPosition="left" (click)="revokeAccess(enrollment)">
                  <i class="pi pi-ban"></i>
                </button>
              </td>

            </tr>
          </ng-template>

          <ng-template pTemplate="emptymessage">
            <tr>
              <td colspan="5" class="text-center py-3xl text-tertiary">
                No students match your search criteria.
              </td>
            </tr>
          </ng-template>
        </p-table>
      </div>
    } @else {
      <div class="empty-state surface-subtle">
        <div class="icon-circle"><i class="pi pi-users text-tertiary"></i></div>
        <h3>No students enrolled yet</h3>
        <p class="text-secondary">Once students purchase your course, they will appear here.</p>
      </div>
    }
  </div>
</div>